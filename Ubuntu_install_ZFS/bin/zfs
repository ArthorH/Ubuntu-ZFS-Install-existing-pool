#!/bin/bash

identify_ubuntu_dataset_uuid() {
    rootzfs_full_name=0
    rootzfs_full_name="$(zfs list -o name | awk '/ROOT\/ubuntu/{print $1;exit}'|sed -e 's,^.*/,,')"
}

get_existing_pool_info() {
    # List imported pools
    echo "Scanning for imported ZFS pools..."
    pools_list=$(zpool list -H -o name)
    
    if [ -z "$pools_list" ]; then
        echo "No imported ZFS pools found. Please import your pool first."
        exit 1
    fi
    
    user_action_banner "Select the existing ZFS pool to install into."
    nl_pool_list=$(echo "$pools_list" | nl)
    echo "$nl_pool_list"
    
    count=$(echo "$pools_list" | wc -l)
    n=""
    while true; do
        read -r -p 'Select option: ' n
        if [ -n "$n" ] && [ "$n" -eq "$n" ] 2>/dev/null && [ "$n" -gt 0 ] && [ "$n" -le "$count" ]; then
            break
        fi
    done
    
    RPOOL=$(echo "$pools_list" | sed -n "${n}p")
    echo "Selected pool: $RPOOL"
    
    # Check for ROOT dataset
    if ! zfs list "$RPOOL/ROOT" >/dev/null 2>&1; then
        echo "Warning: $RPOOL/ROOT dataset not found. Created it."
        zfs create -o canmount=off -o mountpoint=none "$RPOOL/ROOT"
    fi
    
    user_action_banner "Enter a name for the new installation (dataset suffix).\nExample: ubuntu-24.04-custom"
    read -r -p 'Install Name: ' new_install_name
    
    # Sanitize input
    new_install_name=$(echo "$new_install_name" | tr -cd '[:alnum:]._-')
    
    if [ -z "$new_install_name" ]; then
        echo "Invalid name. Using default timestamp."
        rootzfs_full_name="ubuntu.$(date +%Y.%m.%d)"
    else
        rootzfs_full_name="$new_install_name"
    fi
    
    if zfs list "$RPOOL/ROOT/$rootzfs_full_name" >/dev/null 2>&1; then
        echo "Error: Dataset $RPOOL/ROOT/$rootzfs_full_name already exists!"
        exit 1
    fi
    
    echo "New installation will be at: $RPOOL/ROOT/$rootzfs_full_name"
}

create_zpool_Func() {
    ## Create zfs pool
    pool=$1 ## root, data
    
    ## Set pool variables
    case "$pool" in
        root)
            ashift="$zfs_rpool_ashift"
            zpool_partition="-part2"
            zpool_name="$RPOOL"
            topology_pool="${topology_root}"
        ;;
        data)
            ashift="$zfs_dpool_ashift"
            zpool_partition=""
            zpool_name="$datapool"
            topology_pool="${topology_data}"
        ;;
    esac
    
    zpool_create_temp="/tmp/${pool}_creation.sh"
    cat > "$zpool_create_temp" <<-EOF
		zpool create -f \\
			-o ashift="$ashift" \\
			-o autotrim=on \\
			-O acltype=posixacl \\
			-O compression=$zfs_compression \\
			-O normalization=formD \\
			-O relatime=on \\
			-O dnodesize=auto \\
			-O xattr=sa \\
	EOF

    if [ "$pool" = "root" ]; then
        echo -O canmount=off \\ >> "$zpool_create_temp"
    fi

    
    case "$pool" in
        root) echo "-O mountpoint=/ -R $mountpoint \\" >> "$zpool_create_temp" ;;
        data) echo "-O mountpoint=$datapoolmount \\" >> "$zpool_create_temp" ;;
    esac

    add_zpool_disks() {
        loop_counter="$(mktemp)"
        echo 1 > "$loop_counter"
        
        while IFS= read -r diskidnum; do
            echo "/dev/disk/by-id/${diskidnum}${zpool_partition} \\" >> "$zpool_create_temp"
        done < "/tmp/diskid_check_$pool".txt
        sed -i '$s,\\,,' "$zpool_create_temp"
    }

    case "${topology_pool}" in
        single|raid0) echo "${zpool_name} \\" >> "$zpool_create_temp"; add_zpool_disks ;;
        mirror)      echo "${zpool_name} mirror \\" >> "$zpool_create_temp"; add_zpool_disks ;;
        raidz1)      echo "${zpool_name} raidz1 \\" >> "$zpool_create_temp"; add_zpool_disks ;;
        raidz2)      echo "${zpool_name} raidz2 \\" >> "$zpool_create_temp"; add_zpool_disks ;;
        raidz3)      echo "${zpool_name} raidz3 \\" >> "$zpool_create_temp"; add_zpool_disks ;;
        *) exit 1 ;;
    esac
    
    sh "$zpool_create_temp" 
}

debootstrap_createzfspools_Func() {
    create_zpool_Func root
    mountpointsFunc
}

mountpointsFunc() {
    # Create filesystem datasets
    # Only create ROOT if it doesn't already exist (handled in get_existing_pool_info for interactive mode)
    if [ -z "${OS_INSTALL_MODE:-}" ]; then
        zfs create -o canmount=off -o mountpoint=none "$RPOOL/ROOT"
        rootzfs_full_name="ubuntu.$(date +%Y.%m.%d)"
    else
        # In OS_INSTALL_MODE, RPOOL and rootzfs_full_name are set by get_existing_pool_info
        # altroot is read-only; we must re-import with -R to change it for the install session
        current_altroot=$(zpool get -H -o value altroot "$RPOOL")
        if [ "$current_altroot" != "$mountpoint" ]; then
            echo "Pool $RPOOL has altroot '$current_altroot', but we need '$mountpoint'. Re-importing..."
            
            # Check if we are running from the pool we're trying to export
            if df / --output=source | grep -q "^${RPOOL}/"; then
                echo "CRITICAL ERROR: You are running this script from a dataset within the pool '$RPOOL' which is mounted at /."
                echo "ZFS cannot export a pool while it is in use as the root filesystem."
                echo "Please copy the 'Ubuntu_install_ZFS' folder to /tmp/ and run it from there:"
                echo "  cp -r ~/Ubuntu_install_ZFS /tmp/ && sudo /tmp/Ubuntu_install_ZFS/install.sh osinstall"
                exit 1
            fi

            # Force unmount all datasets in the pool to release 'busy' handles
            zfs unmount -a -f || true
            zpool export -f "$RPOOL" || true
            
            # Attempt re-import
            if ! zpool import -f -R "$mountpoint" -N "$RPOOL"; then
                echo "Error: Failed to re-import pool '$RPOOL' with altroot '$mountpoint'."
                exit 1
            fi
        fi
    fi
                
    zfs create -o canmount=noauto -o mountpoint=/ "$RPOOL/ROOT/$rootzfs_full_name"
    zfs mount "$RPOOL/ROOT/$rootzfs_full_name"
    zpool set bootfs="$RPOOL/ROOT/$rootzfs_full_name" "$RPOOL"
    
    # Single dataset setup (everything on root) as requested
    mkdir -p "$mountpoint/root"
    chmod 700 "$mountpoint/root"
    mkdir -p "$mountpoint/var/tmp"
    chmod 1777 "$mountpoint/var/tmp"

    mkdir -p "$mountpoint/run"
    mount -t tmpfs tmpfs "$mountpoint/run"
}
